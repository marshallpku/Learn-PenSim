---
title: "Exploratory Analysis of Model Outputs"
author: "Yimeng Yin"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 4
---


```{r mainSet_options, echo=FALSE, cache=FALSE}

# options(width=140)
# knitr::opts_chunk$set(fig.width=16, fig.height=5, echo=FALSE)
# # Note: when saving maps (ggsave), width=16, height=9 seems to get rid of white space

```




```{r Preamble, echo = FALSE, include  = FALSE}
library(reshape2)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(magrittr) # to use %<>%
library(zoo)
library(grid)

rm(list = ls())

run_knitr <- F

if(run_knitr) source("../Functions.R") else source("Functions.R")

```


```{r Read, echo=FALSE, include = FALSE}
## Combine selected files into a single list.

IO_folder <- "IO_M1_new"

if(run_knitr) IO_folder <- paste0("../", IO_folder)

file_select <- dir(IO_folder, pattern = ".RData")

fn <- function(x) {
       load(paste0(IO_folder, "/", x))
       outputs_list}


lists_all        <- alply(file_select, 1, fn)
names(lists_all) <- laply(lists_all, function(x) x$paramlist$runname)

## Combine the results into a single data frame.
results_all <- ldply(lists_all, function(x) x$results) %>% select(-X1)

rm(lists_all)
```


```{r Read, echo=FALSE, include = FALSE}

results_all %<>% group_by(runname, sim) %>% 
                 mutate(dFR = FR - lag(FR),
                        dFR_MA = FR_MA - lag(FR_MA),
                        dC_PR = C_PR - lag(C_PR),
                        dERC_PR = ERC_PR - lag(ERC_PR)
                        ) %>% 
                 ungroup

var.display <- c( "runname", "year",
                 "FR","AL","AA",
                 #"AL_PR", "AL.act_PR", "AL.ret_PR","AL.term_PR", 
                 "NC_PR", "NC.act_PR", "NC.term_PR", 
                 "SC_PR", "C_PR", "ERC_PR",
                 "MA_PR",   
                 "PR.growth", 
                 "ExF_PR",
                 "AL", "C","B","PR",
                 "ExF"
)

results_all %>% filter(runname == "A1F075_0", year == 1, sim == 1) %>% select(one_of(var.display))

```



# Funding policies


```{r, echo = FALSE, cache = F , eval = TRUE, fig.width=20, fig.height=4}

prefix <- "A1F075_"


runs_M1_F11 <- c(
 "0",
 "O15d",
 "O15p",
 "O30d",
 "O30p",
 "C30p",
 "O30pA5"
)
  
runs_M1_O <- c(
# "0",  
 "O15d",
 "O15p",
 "O30d",
 "O30p",  
 "O30pA5",
 "O30pA10"
)

runs_M1_C <- c(
 # "0",  
 "C15d",
 "C15p",
 "C30d",
 "C30p",  
 "C30pA5",
 "C30pA10"
)


runs_M1_soa <- c(
  "O30pA5",
  "soa1", "soa2", "soa3", "soa4"
)


runs_M1_0 <- c( "0u","0","A5","A10")


draw_quantiles(c(paste0(prefix, runs_M1_F11)), "FR_MA",  ylim = c(0, 250), year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_F11)), "C_PR",   ylim = c(-2, 35),  year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_F11)), "ERC_PR", ylim = c(-2, 35),year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_F11)), "MA_PR",  year.max = 60)$plot %>% print


draw_quantiles(c(paste0(prefix, runs_M1_O)), "FR_MA",  ylim = c(0, 250), year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_O)), "C_PR",   ylim = c(-2, 35),  year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_O)), "ERC_PR", ylim = c(-2, 35),year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_O)), "MA_PR",  year.max = 60)$plot %>% print



draw_quantiles(c(paste0(prefix, runs_M1_C)), "FR_MA", ylim = c(0, 250), year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_C)), "C_PR",  ylim = c(-2, 35),  year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_C)), "ERC_PR",ylim = c(-2, 35),year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_C)), "MA_PR", year.max = 60)$plot %>% print

draw_quantiles(c(paste0(prefix, runs_M1_soa)), "FR_MA", ylim = c(0, 250), year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_soa)), "C_PR",  ylim = c(-2, 50),  year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_soa)), "ERC_PR",ylim = c(-2, 50),year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_soa)), "MA_PR", ylim = c(-2, 50),year.max = 60)$plot %>% print

draw_quantiles(c(paste0(prefix, runs_M1_0)), "FR_MA", ylim = c(0, 250), year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_0)), "C_PR",  ylim = c(-2, 35),  year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_0)), "ERC_PR",ylim = c(-2, 35),year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_0)), "MA_PR", ylim = c(-2, 35),year.max = 60)$plot %>% print


# "A1F100_O30pA5",
draw_quantiles(c("A1F075_O30pA5", "A1F100_O30pA5"), "FR_MA", ylim = c(0, 250), year.max = 60)$plot %>% print
draw_quantiles(c("A1F075_O30pA5", "A1F100_O30pA5"), "C_PR", ylim = c(-2, 35),  year.max = 60)$plot %>% print
draw_quantiles(c("A1F075_O30pA5", "A1F100_O30pA5"), "ERC_PR", ylim = c(-2, 35),year.max = 60)$plot %>% print
draw_quantiles(c("A1F075_O30pA5", "A1F100_O30pA5"), "MA_PR", ylim = c(-2, 35),year.max = 60)$plot %>% print


# # Amortization period with cp payment
# draw_quantiles(paste0(prefix, c(0, 1, "1cp",2,3,6, "3c")) , "FR_MA",    ylim = c(0, 250))$plot + 
#   labs(y = "%", title = "Quantile Plots of Funded Ratio(Based on Market Asset Value)")
# draw_quantiles(paste0(prefix, c(0, 1, "1cp",2,3,6, "3c")) , "C_PR",   ylim = c(-2, 35))$plot +
#   labs(y = "%", title = "Quantile Plots of Contribution Rate")
# draw_quantiles("A1F075_6" , "FR_MA", ylim = c(0, 250))$df %>% filter(Quantile == "50%")

```


# -25% asset shock

```{r, echo = FALSE, cache = F , eval = TRUE, fig.width=20, fig.height=4}


prefix <- "A1F075_"

runs_M1_shock <- c(
"0_a",
"O30p_a",
"O30pA5_a",
"O30pA10_a"
)

draw_quantiles(c(paste0(prefix, runs_M1_shock)), "FR",     ylim = c(0, 250), year.max = 20)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_shock)), "C_PR",   ylim = c(-2, 35),  year.max = 20)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_shock)), "ERC_PR", ylim = c(-2, 35),year.max = 20)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_shock)), "MA_PR",  year.max = 20)$plot %>% print


```


# Geo vs arith mean

0: ir.mean = 7.5; 1: ir.mean = 8.22


```{r, echo = FALSE, cache = F , eval = TRUE, fig.width=20, fig.height=4}

prefix <- "B1F075_"

runs_M1_GvA <- c(0, 1)

draw_quantiles(c(paste0(prefix, runs_M1_GvA)), "FR_MA", ylim = c(0, 250),  year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_GvA)), "C_PR",  ylim = c(-2, 35),  year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_GvA)), "ERC_PR", ylim = c(-2, 35), year.max = 60)$plot %>% print
draw_quantiles(c(paste0(prefix, runs_M1_GvA)), "MA_PR", year.max = 60)$plot %>% print

```











