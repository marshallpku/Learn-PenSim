---
title: "Exploratory Analysis of Model Outputs"
author: "Yimeng Yin"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 4
---


```{r mainSet options, echo=FALSE, cache=FALSE}

# options(width=140)
# knitr::opts_chunk$set(fig.width=16, fig.height=5, echo=FALSE)
# # Note: when saving maps (ggsave), width=16, height=9 seems to get rid of white space

```


```{r Preamble, echo = FALSE, include  = FALSE}
library(reshape2)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(magrittr) # to use %<>%
library(zoo)
library(grid)

rm(list = ls())

run_knitr <- F

if(run_knitr) source("../Functions.R") else source("Functions.R")

```


```{r, echo=FALSE, include = FALSE}
## Combine selected files into a single list.

if(run_knitr) folder_run <- "../IO_M2.1" else folder_run <- "IO_M2.1"

file_select <- dir(folder_run, pattern = ".RData")

fn <- function(x) {
       load(paste0(folder_run, "/", x))
       outputs_list
  }

lists_all        <- alply(file_select, 1, fn)
names(lists_all) <- laply(lists_all, function(x) x$paramlist$runname)

## Combine the results into a single data frame.
results_all <- ldply(lists_all, function(x) x$results) %>% select(-X1)

rm(lists_all)
```


```{r Read, echo=FALSE, include = FALSE}
results_all %<>% group_by(runname, sim) %>% 
                 mutate(dFR = FR - lag(FR),
                        dFR_MA = FR_MA - lag(FR_MA),
                        dC_PR = C_PR - lag(C_PR),
                        dERC_PR = ERC_PR - lag(ERC_PR),
                        dPR = (PR - lag(PR))/ PR,
                        MA_PR = 100* MA / PR,
                        abratio =  nactives/nretirees,
                        MA_B  = MA / B,
                        NCF   = C + I.r - B,
                        XF   = (C - B) , 
                        I.r_C = I.r/(I.r + C),
                        SC_PR = SC / PR
                        ) %>% 
                 ungroup
```


## Demographics, 100% Initial Funding, no workforce growth

Columns:
1.	Average
2.	Young Plan
3.	Old Plan
4.	High abratio
5.	Underfunded Teachers

```{r, echo = FALSE, cache = F , eval = TRUE, fig.width=20, fig.height=4}

# What are the age and yos distribution of actives of each plan?

# Old plan is a mature or overmature plan: old active members, low abratio
#  


planName <- "youngplan"
planName <- "oldplan"
planName <- "highabratio"
planName <- "average"


actives %<>% mutate(yos = age - ea) 

df_age <- actives %>% filter(planname == planName) %>% group_by(age) %>% 
          summarize(nactives_age = sum(nactives)) %>% mutate(pct_age =100* nactives_age / sum(nactives_age)) 

df_ea <-  actives %>% filter(planname == planName) %>% group_by(ea)  %>% 
          summarize(nactives_ea = sum(nactives))  %>% mutate(pct_ea =100* nactives_ea / sum(nactives_ea)) %>% rename(age = ea)

df_yos <- actives %>% filter(planname == planName) %>% group_by(yos) %>% summarize(nactives_yos = sum(nactives)) %>% mutate(pct_yos =100* nactives_yos / sum(nactives_yos))



df_dist <- data.frame(age = 20:64, pct_ent = 100*get_entrantsDist(actives, planName, simple = TRUE))

df_age  %>% ggplot(aes(x = age,  y = pct_age)) + geom_bar(stat = "identity") + theme_bw() + 
            labs(title = "Age Distribution of actives", y = "%")

df_yos  %>% ggplot(aes(x = yos,  y = pct_yos)) + geom_bar(stat = "identity") + theme_bw() + 
            labs(title = "Year of Service Distribution of actives", y = "%")

df_ea  %>% ggplot(aes(x = age,  y = pct_ea)) + geom_bar(stat = "identity") + theme_bw() + 
            labs(title = "Entry Age Distribution of actives", y = "%")


df_dist %>% ggplot(aes(x = age,  y = pct_ent)) + geom_bar(stat = "identity") + theme_bw() + 
            labs(title = "Age Distribution of New Entrants", y = "%")


df_age.r <- retirees %>% filter(planname == planName) %>% group_by(age) %>% 
            summarize(nretirees_age = sum(nretirees)) %>% mutate(pct_age =100* nretirees_age / sum(nretirees_age)) 

df_age.r %>% ggplot(aes(x = age,  y = pct_age)) + geom_bar(stat = "identity") + theme_bw() + 
              labs(title = "Age Distribution of retirees", y = "%")


retirees %>% group_by(planname) %>% summarise(nretirees = sum(nretirees))
actives  %>% group_by(planname) %>% summarise(nactives  = sum(nactives))


## Table of summary statistics
actives %>% filter(planname %in% c("average", "youngplan", "oldplan", "highabratio")) %>% mutate(yos = age - ea) %>%
            group_by(planname) %>% 
            summarize(avg_age = weighted.mean(age, nactives),
                      avg_yos = weighted.mean(yos, nactives),
                      avg_ea  = weighted.mean(ea, nactives),
                      avg_sal = weighted.mean(salary, nactives))
            
retirees %>% filter(planname %in% c("youngplan", "oldplan", "highabratio", "average"))  %>% 
            group_by(planname) %>% 
            summarize(avg_age = weighted.mean(age, nretirees))




results_all %>% filter(runname %in% paste0(prefix, c(3, 4, 5), "g"), sim == 1, year == 1) %>% select(year,MA_PR)

```

## Demographics,  100% Initial Funding, 2% workforce growth


Columns:
1.	Average
2.	Young Plan
3.	Old Plan
4.	High abratio
5.	Underfunded Teachers


```{r, echo = FALSE, cache = F , eval = TRUE, fig.width=20, fig.height=4}

prefix <- "DF100-"

DF100g_FR     <- draw_quantiles(paste0(prefix, c(1,3:6), "g" ), "FR",    ylim = c(0, 250))
DF100g_FR_MA     <- draw_quantiles(paste0(prefix, c(1,3:6), "g" ), "FR_MA",    ylim = c(0, 250))
DF100g_C_PR   <- draw_quantiles(paste0(prefix, c(1,3:6), "g"), "C_PR",   ylim = c(-2, 35))


DF100g_FR$plot
DF100g_FR_MA$plot
DF100g_C_PR$plot


# DF100g_FR$df %>% glimpse()
# DF100g_C_PR$df
# DF100g_ERC_PR$plot

```

## Demographics,  100% Initial Funding, 0% workforce growth


Columns:
1.	Average
2.	Young Plan
3.	Old Plan
4.	High abratio
5.	Underfunded Teachers


```{r, echo = FALSE, cache = F , eval = TRUE, fig.width=20, fig.height=4}

prefix <- "DF100-"

DF100g_FR     <- draw_quantiles(paste0(prefix, c(3:5)), "FR",    ylim = c(0, 250))
DF100g_FR_MA  <- draw_quantiles(paste0(prefix, c(3:5)), "FR_MA", ylim = c(0, 250))
DF100g_C_PR   <- draw_quantiles(paste0(prefix, c(3:5)), "C_PR",  ylim = c(-2, 35))


DF100g_FR_MA$plot
DF100g_C_PR$plot


# DF100g_FR$df %>% glimpse()
# DF100g_C_PR$df
# DF100g_ERC_PR$plot

```







# Young vs Old

```{r, echo = FALSE, cache = F , eval = TRUE, fig.width=20, fig.height=4}


# Young plan + 2% workforce growth
# Old plan 0 workforce growth
# high a/b ratio plan + 2% workforce growth

prefix <- "DF075-"

D_FR     <- draw_quantiles(paste0(prefix, c("3g", 4, "5g") ), "FR",    ylim = c(0, 250))
D_FR_MA  <- draw_quantiles(paste0(prefix, c("3g", 4, "5g") ), "FR_MA", ylim = c(0, 250))
D_C_PR   <- draw_quantiles(paste0(prefix, c("3g", 4, "5g") ), "C_PR",  ylim = c(-2, 35))


D_FR$plot
D_FR_MA$plot
D_C_PR$plot

 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "FR_MA", ylim = c(0, 250), year.max = 40)$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "C_PR",  ylim = c(-2, 35), year.max = 40)$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "nactives")$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "nretirees")$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "abratio", year.max = 40)$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "dPR")$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "MA_PR", ylim = c(-0.5, 15), year.max = 40)$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "MA_B", ylim = c(-0.5, 40), year.max = 40)$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "NCF", ylim = c(-1e8, 1e8), year.max = 40)$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "AL", ylim = c(0, 2e9))$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "MA", ylim = c(-1e8, 5e9))$plot
 draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "NC_PR")$plot

 
 
  draw_quantiles(paste0(prefix, c("3g",3, 4, 5)),  "FR_MA", ylim = c(0, 250), year.max = 40)$plot
  draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "NC_PR", year.max = 40)$plot
  draw_quantiles(paste0(prefix, c("3g",3, 4, 5)),  "C_PR",  ylim = c(-2, 35), year.max = 40)$plot
  draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "MA_PR", ylim = c(-0.5, 15), year.max = 40)$plot
  draw_quantiles(paste0(prefix, c("3g",3, 4, 5)), "NCF", ylim = c(-1e8, 1e8), year.max = 40)$plot
 
  MAX = 20
  
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "FR_MA", ylim = c(0, 150), year.max = MAX)$plot +
    labs(y = "%", title = "Quantile Plots of Funded Ratio Based on Market Asset Value")
    
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "NC_PR", ylim = c(-0.2,8 ), year.max = MAX)$plot + theme(legend.position = "none") + 
    labs(y = "%", title = "Total Normal Cost Rate")
  
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "C_PR",  ylim = c(-2, 35), year.max = MAX)$plot + 
    labs(y = "%", title = "Quantile Plots of Total Total Contribution Rate")
  
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "AL_PR", ylim = c(90, 650), year.max = MAX)$plot + theme(legend.position = "none") +
   labs(y = "%", title = "Quantile Plots of Liability as a Percentage of Payroll")

  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "MA_PR", ylim = c(90, 700), year.max = 20)$plot + theme(legend.position = "none") +
   labs(y = "%", title = "Quantile Plots of Market as a Percentage of Payroll")
  
    
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "NCF", ylim = c(-1e8, 1e8), year.max = MAX)$plot
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "nactives", year.max = MAX)$plot
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "nretirees", year.max = MAX)$plot
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "abratio", year.max = MAX)$plot
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "dPR", year.max = MAX)$plot
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "XF", year.max = MAX)$plot
  
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "MA", year.max = 20)$plot
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "AL", year.max = 20)$plot
  
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "PR", year.max = 20)$plot
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "B", year.max = 20)$plot
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "XF", year.max = 20)$plot
  draw_quantiles(paste0(prefix, c(3, 4, 5), "g"), "C", year.max = 20)$plot
  
   x = liab$active %>% mutate(ALx_sx = ALx / sx)
   x %<>% arrange(ea)  

## Meature of short term volatility
   
   get_vol_MA <- function(runName, year.max, data = results_all){
         df <-  data %>% 
                filter(runname == runName, year <= year.max) %>%
                group_by(sim) %>% 
                summarize(avg_dFR     = mean(abs(dFR), na.rm = TRUE),
                          avg_dFR_MA  = mean(abs(dFR_MA), na.rm = TRUE),
                          avg_dC_PR   = mean(abs(dC_PR), na.rm = TRUE),
                          avg_dERC_PR = mean(abs(dERC_PR), na.rm = TRUE)) %>% 
                summarize(m_avg_dFR     = median(avg_dFR),
                          m_avg_dFR_MA  = median(avg_dFR_MA),
                          m_avg_dC_PR   = median(avg_dC_PR),
                          m_avg_dERC_PR = median(avg_dERC_PR)) %>% 
                mutate(runname = runName) %>% 
                select(runname, everything())
}


sum_vol075_MA20 <- adply(paste0("DF075-", c(3, 4, 5), "g"), 1, get_vol_MA, year.max = 20) %>% select(-X1)

sum_vol075_MA20

results_all %>% filter(runname == "IF100-3", sim == 1, year == 1) %>% select(year,MA)
   
   
  
```



## Benefit Policy, 100% Initial Funding, COLA

```{r, echo = FALSE, cache = F , eval = TRUE, fig.width=14, fig.height=6}

prefix <- "BF075-"

draw_quantiles(paste0(prefix, c(1:2)), "FR",    ylim = c(0, 250), year.max = 80)$plot +
   labs(y = "%", title = "Quantile Plots of Funded Ratio Based on Market Asset Value")
draw_quantiles(paste0(prefix, c(1:2)), "C_PR",   ylim = c(-2, 35), year.max = 80)$plot + 
 labs(y = "%", title = "Quantile Plots of Total Contribution Rate")
draw_quantiles(paste0(prefix, c(1:2)), "NC_PR", ylim = c(-0.5, 8))$plot
draw_quantiles(paste0(prefix, c(1:2)), "AL_PR")$plot
draw_quantiles(paste0(prefix, c(1:2)), "MA_PR", year.max = 40)$plot
draw_quantiles(paste0(prefix, c(1:2)), "SC_PR", year.max = 30)$plot


BF100_FR$plot
BF100_C_PR$plot
BF


get_vol_MA <- function(runName, year.max, data = results_all){
         df <-  data %>% 
                filter(runname == runName, year <= year.max) %>%
                group_by(sim) %>% 
                summarize(avg_dFR     = mean(abs(dFR), na.rm = TRUE),
                          avg_dFR_MA  = mean(abs(dFR_MA), na.rm = TRUE),
                          avg_dC_PR   = mean(abs(dC_PR), na.rm = TRUE),
                          avg_dERC_PR = mean(abs(dERC_PR), na.rm = TRUE)) %>% 
                summarize(m_avg_dFR     = median(avg_dFR),
                          m_avg_dFR_MA  = median(avg_dFR_MA),
                          m_avg_dC_PR   = median(avg_dC_PR),
                          m_avg_dERC_PR = median(avg_dERC_PR)) %>% 
                mutate(runname = runName) %>% 
                select(runname, everything())
}


sum_vol075_MA20 <- adply(paste0(prefix, c(1:2)), 1, get_vol_MA, year.max = 20) %>% select(-X1)
sum_vol075_MA20


results_all %>% filter(runname %in% paste0(prefix, c(1:2)), sim == 1, year %in% c(1,40,80)) %>% select(runname, year, sim, NC_PR, MA_PR)

draw_quantiles(paste0(prefix, c(1:2)), "AL", ylim = c(-0.5, 8))$df %>% filter(Quantile == "50%", year %in% c(1,20, 40, 80)) %>% arrange(year, runname)

# single cell 20-20

draw_quantiles(paste0(prefix, c(1:2), "a"), "FR",    ylim = c(0, 250), year.max = 80)$plot
draw_quantiles(paste0(prefix, c(1:2)), "C_PR",   ylim = c(-2, 35), year.max = 80)$plot

draw_quantiles(paste0(prefix, c(1:2)), "NC_PR", ylim = c(-0.5, 8))$plot
draw_quantiles(paste0(prefix, c(1:2), "a"), "AL.act")$plot
draw_quantiles(paste0(prefix, c(1:2)), "MA_PR", year.max = 40)$plot
draw_quantiles(paste0(prefix, c(1:2)), "SC_PR", year.max = 30)$plot



```


# Investment volatility

```{r, echo = FALSE, cache = F , eval = TRUE, fig.width=20, fig.height=4}

prefix <- "I2F075-"
prefix <- "I3F100-"
prefix <- "I3F075-"

IF100g_FR     <- draw_quantiles(paste0(prefix, c(1:5) ), "FR",    ylim = c(0, 250))
IF100g_FR_MA  <- draw_quantiles(paste0(prefix, c(1:5) ), "FR_MA",    ylim = c(0, 250)) 
IF100g_C_PR   <- draw_quantiles(paste0(prefix, c(1:5) ), "C_PR",   ylim = c(-2, 35))


IF100g_FR$plot 
IF100g_FR_MA$plot + labs(title = "Quantile Plots for Funded Ratio (based on market asset value)", y = "%")
IF100g_C_PR$plot + labs(title = "Quantile Plots for Total Contribution Rate", y = "%")



```



```{r, echo = FALSE, cache = F , eval = TRUE, fig.width=20, fig.height=4}

prefix <- "I2F075-"
prefix <- "I3F100-"
prefix <- "I3F075-"


get_vol_MA <- function(runName, year.max, data = results_all){
         df <-  data %>% 
                filter(runname == runName, year <= year.max) %>%
                group_by(sim) %>% 
                summarize(avg_dFR     = mean(abs(dFR), na.rm = TRUE),
                          avg_dFR_MA  = mean(abs(dFR_MA), na.rm = TRUE),
                          avg_dC_PR   = mean(abs(dC_PR), na.rm = TRUE),
                          avg_dERC_PR = mean(abs(dERC_PR), na.rm = TRUE)) %>% 
                summarize(m_avg_dFR     = median(avg_dFR),
                          m_avg_dFR_MA  = median(avg_dFR_MA),
                          m_avg_dC_PR   = median(avg_dC_PR),
                          m_avg_dERC_PR = median(avg_dERC_PR)) %>% 
                mutate(runname = runName) %>% 
                select(runname, everything())
}


sum_vol075_MA20 <- adply(paste0(prefix, 1:5), 1, get_vol_MA, year.max = 20) %>% select(-X1)

sum_vol075_MA20

results_all %>% filter(runname == "IF100-3", sim == 1, year == 1) %>% select(year,MA)


```













