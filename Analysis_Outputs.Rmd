---
title: "Exploratory Analysis of Model Outputs"
author: "Yimeng Yin"
date: "June 7, 2015"
output: html_document
---


```{r Preamble, echo = FALSE, include  = FALSE}
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)

rm(list = ls())
source("Functions.R")


```


```{r Read, echo=FALSE, include = FALSE}
## Combine selected files into a single list.
folder_outputs <- "Outputs_Initial_Runs_2"
file_select <- dir(folder_outputs, pattern = "06-07")

fn <- function(x) {
       load(paste0(folder_outputs, "/", x))
       outputs_list
  }

lists_all        <- alply(file_select, 1, fn)
names(lists_all) <- laply(lists_all, function(x) x$paramlist$runname)

## Combine the results into a single data frame.
results_all <- ldply(lists_all, function(x) x$results) %>% select(-X1)



```


```{r, include = FALSE}

# select variables to be displayed in the kable function. See below for a list of all avaiable variables and explanations.
var.display <- c("year",  "AL",    "MA",    "AA",   "FR", "FR_MA",
                 # "ExF",   
                 "UAAL",  "EUAAL", "LG",    "NC",    "SC",    
                 "ADC", "EEC", "ERC",  "C", "B",     
                 # "I.r" ,   "I.e", 
                 "i",    "i.r",
                 "ADC_PR", "C_PR", "ERC_PR", "dERC_PR"
                 # "AM", "PR",
                 # "C_ADC"
                 )

r1 <- results_all %>% filter(sim %in% 2, runname == "R4F1") %>% select(one_of(var.display))
kable(r1, digits = 2)



```


```{r Draw_function, echo = FALSE, include = FALSE}
draw_quantiles <- function(runName,     # character
                           varName,     # character
                           data = results_all,
                           year.max = 50,
                           qts = c(0.1, 0.25, 0.5, 0.75, 0.9)){
  
  df <- data %>% filter(runname == runName) %>%  
        select_("sim","year", varName) %>% spread_("year", varName)
  
  df_q <-   sapply(select(df, -sim), function(x) quantile(x, qts)) %>% 
    as.data.frame
  
  df_q %<>% mutate(Quantile = rownames(df_q)) %>% gather(year, Value, -Quantile) %>%
    mutate(year = f2n(year),
           Quantile = factor(Quantile)) %>% 
    filter(year <= year.max)
  
  
  ggplot(df_q, aes(x = year, y = Value, color = Quantile)) + theme_bw() + 
    geom_point(size = 2.5) + geom_line()+ 
    labs(y = varName, title = paste0("Quantile plot of ", varName, " in ", runName))
}


```



# Variables to Examine
- **FR:** Funded ratio
- **ERC_PR:** Employer contribution rates
- **C_PR:** Total contribution rates
- **B_PR:** Benefit payment rates 


# Scenario 1 
Fixed Return Fixed discount rate and investment return, 7.5% each; Smoothed

```{r S1, echo = FALSE}

draw_quantiles("R1F1", "FR")
draw_quantiles("R1F1", "ERC_PR")
draw_quantiles("R1F1", "C_PR")
draw_quantiles("R1F1", "B_PR")

```


# Scenario 2 
Fixed discount rate 7.5%, fixed investment return 5.5%; Smoothed

```{r S2, echo = FALSE}

prefix <- "R2F"

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "FR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "ERC_PR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "C_PR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "B_PR") %>% print
}

```


# Scenario 3 
Fixed discount rate 7.5%, fixed investment return  9.5%; smoothed


```{r S3, echo = FALSE}

prefix <- "R3F"

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "FR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "ERC_PR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "C_PR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "B_PR") %>% print
}

```


# Scenario 4 
Fixed discount rate 7.5%, stochastic investment return arithmetic mean 7.5%, sd 12%; Smoothed


```{r S4, echo = FALSE}

prefix <- "R4F"

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "FR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "ERC_PR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "C_PR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "B_PR") %>% print
}

```


# Scenario 5 
Fixed Return Fixed discount rate and investment return, 7.5% each, with 5-year period of low returns; Smoothed


```{r S5, echo = FALSE}

prefix <- "R5F"

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "FR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "ERC_PR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "C_PR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "B_PR") %>% print
}

```



# Scenario 6 
Fixed Return Fixed discount rate and investment return, 7.5% each, with a 5-year period of low employer contributions; Smoothed


```{r S6, echo = FALSE}

prefix <- "R6F"

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "FR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "ERC_PR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "C_PR") %>% print
}

for (runname in paste0(prefix, 1:3)){
  draw_quantiles(runname, "B_PR") %>% print
}

```



# Look at the Geometric returns in Scenario 4


```{r geoReturn, echo = FALSE}

get_geoReturn <- function(x) prod(1 + x)^(1/length(x)) - 1

df <- results_all %>% filter(runname == "R4F1") %>%  group_by(sim) %>% 
      summarise(geoReturn = get_geoReturn(i.r))

df$geoReturn %>% summary
df$geoReturn %>% hist(40, FALSE,  main = "Histogram of Geometric Returns")
abline(v = 0.075, col = "red")


```

