---
title: "Demo Runs of the Simulation Model"
author: "Yimeng Yin"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 4
---


```{r mainSet options, echo=FALSE, cache=FALSE}

options(width=120)
knitr::opts_chunk$set(fig.width=14, fig.height=5, echo=FALSE)
# Note: when saving maps (ggsave), width=16, height=9 seems to get rid of white space

```




```{r Preamble, echo = FALSE, include  = FALSE}
library(reshape2)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(magrittr) # to use %<>%

rm(list = ls())
source("../Functions.R")
# source("Functions.R")

```


```{r Read, echo=FALSE, include = FALSE}
## Combine selected files into a single list.

folder_run <- "../IO_DemoRun"
# folder_run <- "IO_DemoRun"
file_select <- dir(folder_run, pattern = ".RData")


fn <- function(x) {
       load(paste0(folder_run, "/", x))
       outputs_list
  }

lists_all        <- alply(file_select, 1, fn)
names(lists_all) <- laply(lists_all, function(x) x$paramlist$runname)

## Combine the results into a single data frame.
results_all <- ldply(lists_all, function(x) x$results) %>% select(-X1)


```


```{r, echo = FALSE, eval = FALSE}

# select variables to be displayed in the kable function. See below for a list of all avaiable variables and explanations.

var.display <- c("runname", "year",  "AL",    "AA",   "FR", "NC",    "SC", "UAAL",
                "AL_PR", "NC_PR", "C_PR", "ERC_PR", "PR")

r1 <- results_all %>% filter(sim %in% 1, year == 1) %>% select(one_of(var.display))
kable(r1, digits = 2)



```



# Variables 
- **FR:** Funded ratio
- **ERC_PR:** Employer contribution rates



# Funding Policies:

**Policy 1:** Highly smoothed

- asset smoothing: 10 years;
- amortization: constant percent, 30 years, open


**Policy 2:** typical

- asset smoothing: 5 years;
- amortization constant percent, 20 years, open



# Scenario 
 - Fixed discount rate 7.5%
 - stochastic investment return: mean = 7.5%, sd = 12%

## Quanitle Plots

```{r S4, echo = FALSE, cache = F}

Runs <- c("Smoothed", "Typical")

(draw_quantiles(Runs, "FR", ylim = c(-5, 200)) + geom_hline(yintercept = 100, color = "black", linetype = 2)) %>% print

draw_quantiles(Runs, "ERC_PR", ylim = c(-2, 20)) %>% print

# draw_quantiles(paste0(prefix, 1:3), "C_PR", ylim = c(-2, 30)) %>% print

# draw_quantiles(paste0(prefix, 1:3), "B_PR") %>% print

```


## Examples of Single Simulations: Path is important 


Runs that ends up with similar funded ratio and contribution rates can experience distinct paths. 

```{r S4_singleSim1, echo = FALSE, cache = F， eval = T}
demoSingle1 <- results_all %>% select(runname, year, sim, FR, ERC_PR) %>% gather(variable, value, -runname, -year, - sim) %>% filter(sim %in% c(66,113, 786))
# 786

# results_all %>% select(runname, year, sim, FR, ERC_PR) %>% filter(year == max(year), FR >= 57, FR <= 60)


demoSingle1 %>% filter(runname == "Typical") %>% ggplot(aes(x = year, y = value, color = factor(sim) )) + theme_bw() + 
               facet_wrap( ~ variable, scales = "free_y") +  # coord_cartesian(ylim = c(-5, 200)) +
               geom_line(alpha = 0.6) + geom_point(alpha = 0.6) + 
               labs(title = 'Paths of Funded Ratio and Employer Contribution Rates for Selected Runs ("Typical Funding Policy")') 


# demoSingle1 %>% filter(variable == "ERC_PR") %>% ggplot(aes(x = year, y = value, color = factor(sim) )) + theme_bw() + 
#                facet_grid(. ~ runname) +  coord_cartesian(ylim = c(-2,30)) +
#                geom_line(alpha = 0.6) + geom_point(alpha = 0.6)
```


Paths of funded ratio and contribution rate under different Funding Policies.

```{r S4_singleSim2, echo = FALSE, cache = F， eval = T}
# Compare funding policy under the same simulation

demoSingle2 <- results_all %>% select(runname, year, sim, FR, ERC_PR, i.r) %>% 
               gather(variable, value, -runname, -year, - sim) %>% 
               filter(sim %in% c(66,113, 786))
# 45, 600, 700

demoSingle2 %>% filter(variable == "FR") %>% ggplot(aes(x = year, y = value, color = runname)) + theme_bw() + 
                facet_grid(. ~ sim) +  coord_cartesian(ylim = c(-5,150)) +
                geom_line() + geom_point() + 
                labs(y = "Funded Ratio (%)", title = "Funded Ratio of Selected Runs under Different Funding Policies") +
                geom_hline(yintercept = 100, color = "black", linetype = 2)

demoSingle2 %>% filter(variable == "ERC_PR") %>% ggplot(aes(x = year, y = value, color = runname)) + theme_bw() + 
                facet_grid(. ~ sim) +  coord_cartesian(ylim = c(-1,20)) +
                geom_line() + geom_point() + 
                labs(y = "Employer Contribution Rate(%)", 
                     title = "Employer Contribution Rates of Selected Runs under Different Funding Policies")

# demoSingle2 %>% filter(variable == "i.r") %>% ggplot(aes(x = year, y = value, color = runname)) + theme_bw() + 
#                facet_grid(. ~ sim) +
#                geom_line() + geom_point()

# results_all %>% select(runname, i.r, year, sim) %>% filter(sim %in% 1:3, year %in% 1:3)

```






# Geometric mean of returns 


```{r geoReturn, echo = FALSE}

get_geoReturn <- function(x) prod(1 + x)^(1/length(x)) - 1

df <- results_all %>% filter(runname == "Typical") %>%  group_by(sim) %>% 
      summarise(geoReturn = get_geoReturn(i.r))

df$geoReturn %>% summary
df$geoReturn %>% hist(40, FALSE,  main = "Histogram of Geometric Returns")
abline(v = 0.075, col = "red")

```








```{r move_file, eval= FALSE}



```




