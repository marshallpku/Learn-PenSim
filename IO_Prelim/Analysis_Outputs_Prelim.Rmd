---
title: "Exploratory Analysis of Model Outputs"
author: "Yimeng Yin"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 4
---


```{r mainSet options, echo=FALSE, cache=FALSE}

options(width=120)
knitr::opts_chunk$set(fig.width=14, fig.height=5, echo=FALSE)
# Note: when saving maps (ggsave), width=16, height=9 seems to get rid of white space

```




```{r Preamble, echo = FALSE, include  = FALSE}
library(zoo)
library(reshape2)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(magrittr) # to use %<>%


rm(list = ls())
# source("../Functions.R")
source("Functions.R")

```


```{r Read, echo=FALSE, include = FALSE}
## Combine selected files into a single list.

# folder_run <- "../IO_Prelim"
folder_run <- "IO_Prelim"

file_select <- dir(folder_run, pattern = ".RData")


fn <- function(x) {
       load(paste0(folder_run, "/", x))
       outputs_list
  }

lists_all        <- alply(file_select, 1, fn)
names(lists_all) <- laply(lists_all, function(x) x$paramlist$runname)

## Combine the results into a single data frame.
results_all <- ldply(lists_all, function(x) x$results) %>% select(-X1)

results_all2 <- results_all %>% filter(runname != "R3F1cd")

```


```{r, echo = FALSE}

# select variables to be displayed in the kable function. See below for a list of all avaiable variables and explanations.

var.display <- c("runname", "year",  "AL",    "AA",   "FR", "NC",    "SC", "UAAL",
                "AL_PR", "NC_PR", "C_PR", "ERC_PR", "PR")

r1 <- results_all %>% filter(sim %in% 1, year == 1) %>% select(one_of(var.display))
kable(r1, digits = 2)

r1$PR_growth

```



# Variables to Examine
- **FR:** Funded ratio
- **ERC_PR:** Employer contribution rates
- **C_PR:** Total contribution rates
- **B_PR:** Benefit payment rates 


# Funding Policies:
**F1:** Highly smoothed

- asset smoothing: 10 years;
- amortization: constant percent, 30 years, open


**F2:** highly unsmoothed

- market assets;
- amortization: constant dollar, 10 years, closed


**F3:** typical

- asset smoothing: 5 years;
- amortization constant percent, 20 years, open



# Notes

Using rp2000.hybrid


# Scenario 1 
Fixed Return Fixed discount rate and investment return, 7.5% each


```{r S1, echo = FALSE, cache = F , eval = TRUE}

prefix <- "R1F"

draw_quantiles(paste0(prefix, 1:2), "FR", results_all2, ylim = c(40, 120)) %>% print

draw_quantiles(paste0(prefix, 1:2), "ERC_PR", ylim = c(-2, 15)) %>% print

draw_quantiles(paste0(prefix, 1:2), "C_PR", ylim = c(-2, 15)) %>% print
# 
# draw_quantiles(paste0(prefix, 1:3), "B_PR") %>% print


```


# Scenario 2 
Fixed discount rate 7.5%, fixed investment return 5.5%

```{r S2, echo = FALSE, cache = F, eval = T}

prefix <- "R2F"

(draw_quantiles(paste0(prefix, 1:2), "FR", results_all2, ylim = c(40, 120)) + 
   theme(legend.position="none") + 
   labs(y = "Funded Ratio (%)", title = "Funded Ratio under Different Policies")
   ) %>% 
   ggsave(filename = "IO_Prelim/R2_FR.png", width = 8, height = 4, dpi = 400)

(draw_quantiles(paste0(prefix, 1:2), "ERC_PR", ylim = c(-2, 15)) + 
   theme(legend.position="none") + 
   labs(y = "Employer Contribution Rate (%)", title = "Employer Contribution Rate under Different Policies")
  ) %>% 
  ggsave(filename = "IO_Prelim/R2_ERC_PR.png", width = 8, height = 4, dpi = 400)

# draw_quantiles(paste0(prefix, 1:2), "C_PR", ylim = c(-2, 15)) %>% print

```


# Scenario 3 
Fixed discount rate 7.5%, fixed investment return  9.5%


```{r S3, echo = FALSE, cache = F, eval = T}

prefix <- "R3F"


# Smoothed vs. Typical, with Full ARC 
(draw_quantiles(paste0(prefix, 1:2), "FR", ylim = c(-10, 200)) + 
  labs(y = "Funded Ratio (%)", title = "Funded Ratio under Different Policies")
) %>% 
   ggsave(filename = "IO_Prelim/R3_FR12.png", width = 8, height = 4, dpi = 400)

(draw_quantiles(paste0(prefix, 1:2), "ERC_PR", ylim = c(-1, 20))  + 
  labs(y = "Employer Contribution Rate (%)", title = "Employer Contribution Rate under Different Policies")
) %>% 
   ggsave(filename = "IO_Prelim/R3_ERC_PR12.png", width = 8, height = 4, dpi = 400)


# draw_quantiles(paste0(prefix, 1:4), "C_PR", ylim = c(-1, 20)) %>% print


# Full ARC vs. ARC cap, with Smoothed  
(draw_quantiles(paste0(prefix, c(1,3)), "FR", results_all2, ylim = c(-10, 200))  + 
  labs(y = "Funded Ratio (%)", title = "Funded Ratio under Different Policies")
) %>% 
   ggsave(filename = "IO_Prelim/R3_FR13.png", width = 8, height = 4, dpi = 400)

(draw_quantiles(paste0(prefix, c(1,3)), "ERC_PR", ylim = c(-1, 20))  + 
  labs(y = "Employer Contribution Rate (%)", title = "Employer Contribution Rate under Different Policies")
) %>% 
   ggsave(filename = "IO_Prelim/R3_ERC_PR13.png", width = 8, height = 4, dpi = 400)


# draw_quantiles(paste0(prefix, 1:4), "C_PR", ylim = c(-1, 20)) %>% print


```

# Constant Dollar vs Constant percentage amortization payment


```{r cd_v_cp, echo = FALSE, cache = F, eval = T}


# cd vs. cp with  Smoothed, Full ARC 
(draw_quantiles(c("R3F1", "R3F1cd", "R3F1gm") , "FR", ylim = c(-10, 200))   + 
 labs(y = "Funded Ratio (%)", title = "Funded Ratio")
) %>% 
 ggsave(filename = "IO_Prelim/R3_FRcdgm.png", width = 9, height = 3, dpi = 400)




draw_quantiles(c("R3F1", "R3F1cd", "R3F1gm") , "ERC_PR", ylim = c(-1, 20)) %>% print

# draw_quantiles(paste0(prefix, 1:4), "C_PR", ylim = c(-1, 20)) %>% print

```



# Geometric Mean vs. Arithmetic Mean

```{r geoReturn, echo = FALSE}

get_geoReturn <- function(x) prod(1 + x)^(1/length(x)) - 1

df <- results_all %>% filter(runname == "R3F1") %>%  group_by(sim) %>% 
      summarise(geoReturn = get_geoReturn(i.r))

(df %>% ggplot( aes(x = geoReturn) ) + theme_bw() + 
  geom_histogram(colour = "darkgreen", fill = "white") + 
  geom_vline(xintercept = c(0.0678, 0.075), linetype = 2, color = "red") + 
  labs(x = "Distribution of Geomatric mean (1000 simulations)") + 
  annotate(geom = "text", x = c(0.0678, 0.075 ), y = 0,
                 label = c("6.78%", "7.5%"),
                 hjust = 0.5, vjust = 1.5, size = 2)
   ) %>% 
  ggsave(filename = "IO_Prelim/geoHist.png", width = 4, height = 4, dpi = 400)


df$geoReturn %>% summary
df$geoReturn %>% hist(40, FALSE,  main = "Histogram of Geometric Returns")
abline(v = c(0.0678, 0.075), col = "red")

```





# Comparison of path 

Paths of funded ratio and contribution rate under different Funding Policies.

```{r S4_singleSim2, echo = FALSE, cache = Fï¼Œ eval = T}

results_all2 %>% select(runname, year, sim, FR, ERC_PR) %>% filter(year == max(year), runname == "R3F1", FR >= 59 , FR <= 61)

# Compare funding policy under the same simulation

demoSingle2 <- results_all %>% select(runname, year, sim, FR, ERC_PR, i.r) %>% 
               filter(runname %in% c("R3F1", "R3F2")) %>% 
               filter(sim %in% c(248, 89, 97)) %>% 
               group_by(runname, sim) %>% 
               mutate(rollingReturn = 100 * rollapply(i.r, 10, get_geoReturn, align = "right", fill = NA)) %>% 
               gather(variable, value, -runname, -year, - sim) 
               
              
              
# 5-year rolling geometric return
(demoSingle2 %>% filter(variable == "rollingReturn", runname == "R3F1") %>% 
                ggplot(aes(x = year, y = value)) + theme_bw() + 
                facet_grid(. ~ sim) + # coord_cartesian(ylim = c(-5,150)) +
                geom_line() + geom_point() + 
                labs(y = "10-Year Rolling Average Return (%)", title = "10-year Rolling Geometric Average Return under Selected Runs")) %>% 
 ggsave(filename = "IO_Prelim/R3_Rolling.png", width = 8, height = 3, dpi = 400)


(demoSingle2 %>% filter(variable == "FR") %>% ggplot(aes(x = year, y = value, color = runname)) + theme_bw() + 
                facet_grid(. ~ sim) +  coord_cartesian(ylim = c(-5,150)) +
                geom_line() + geom_point() + 
                labs(y = "Funded Ratio (%)", title = "Funded Ratio of Selected Runs under Different Funding Policies") +
                geom_hline(yintercept = 100, color = "black", linetype = 2)) %>% 
                ggsave(filename = "IO_Prelim/R3_SingleFR.png", width = 8, height = 3, dpi = 400)

(demoSingle2 %>% filter(variable == "ERC_PR") %>% ggplot(aes(x = year, y = value, color = runname)) + theme_bw() + 
                facet_grid(. ~ sim) +  coord_cartesian(ylim = c(-1,20)) +
                geom_line() + geom_point() + 
                labs(y     = "Employer Contribution Rate(%)", 
                     title = "Employer Contribution Rates of Selected Runs under Different Funding Policies")) %>% 
                ggsave(filename = "IO_Prelim/R3_SingleERC.png", width = 8, height = 3, dpi = 400)

# demoSingle2 %>% filter(variable == "i.r") %>% ggplot(aes(x = year, y = value, color = runname)) + theme_bw() + 
#                facet_grid(. ~ sim) +
#                geom_line() + geom_point()

# results_all %>% select(runname, i.r, year, sim) %>% filter(sim %in% 1:3, year %in% 1:3)

```









```{r move_file, eval= FALSE}

rollapply((1:9)/100 , 5, get_geoReturn, align = "right", fill = NA)





```




